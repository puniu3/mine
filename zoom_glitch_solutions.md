# ズームアウト時のタイル描画グリッチ修正案

`src/camera.js` のズーム機能導入に伴い、`src/renderer.js` でのタイル描画時に隙間（白線）やちらつきが発生する問題について、原因と修正案をまとめました。

## 原因

Canvas 2D API において、`ctx.scale(zoom, zoom)` を使用して浮動小数点の倍率で描画を行う際、隣接するタイルの境界座標がサブピクセル単位（例: 32.5px）になったり、ブラウザのアンチエイリアス処理（画像補間）によって背景色が混ざり込むことで、タイルの間にわずかな隙間が見えることがあります。

## 修正案

以下の4つのアプローチを提案します。

### 案1: 描画領域の拡張 (Overlap) 【推奨】

各タイルを描画する際、実際のサイズよりもわずかに大きく描画することで隙間を埋めます。最も手軽で、スムーズなズームアニメーションを維持できます。

*   **実装イメージ:** `src/renderer.js`
    ```javascript
    // 描画サイズを少し大きくする (例: +0.5px または +1px)
    // ズーム率に応じて調整してもよいが、固定値でも効果あり
    const OVERLAP = 0.5;
    ctx.drawImage(
        textures[block],
        x * TILE_SIZE,
        y * TILE_SIZE,
        TILE_SIZE + OVERLAP,
        TILE_SIZE + OVERLAP
    );
    ```
*   **メリット:** 実装が簡単。スムーズなカメラ移動を阻害しない。
*   **デメリット:** 半透明のブロック（ガラスや水など）の場合、重なった部分の色が濃くなる可能性がある（不透明ブロックのみに適用する判定が必要）。

### 案2: 画像補間の無効化 (Nearest Neighbor)

ドット絵（ピクセルアート）スタイルを維持する場合に有効です。ブラウザの補間処理（ぼかし）を切ることで、エッジがシャープになり、アンチエイリアスによる隙間の透過を防ぎやすくなります。

*   **実装イメージ:** `src/renderer.js`
    ```javascript
    ctx.imageSmoothingEnabled = false; // 描画処理の前に設定
    // ... drawImage ...
    ```
*   **メリット:** ドット絵としてくっきりした見た目になる。
*   **デメリット:** ズーム倍率によってはピクセルの大きさが不均一に見える「ジッター」が発生する場合がある。根本的な座標計算の誤差による隙間は埋まらない場合がある。

### 案3: 座標の整数化 (Integer Snapping)

`ctx.scale` を使わず、全ての座標計算を自前で行い、描画座標とサイズを常に整数（Math.floor/Math.ceil）に丸めます。

*   **実装イメージ:**
    ```javascript
    // ctx.scale(zoom, zoom) は削除
    const drawX = Math.floor((x * TILE_SIZE - cameraX) * zoom);
    const drawY = Math.floor((y * TILE_SIZE - cameraY) * zoom);
    // 幅と高さは切り上げ(ceil)して隙間を防ぐ
    const drawW = Math.ceil(TILE_SIZE * zoom);
    const drawH = Math.ceil(TILE_SIZE * zoom);

    ctx.drawImage(textures[block], drawX, drawY, drawW, drawH);
    ```
*   **メリット:** サブピクセル描画による滲みがなくなる。
*   **デメリット:** 計算コストが若干増える。スムーズなカメラ移動時に、ピクセル単位でカクついて見える（ジッター）可能性がある。

### 案4: オフスクリーンレンダリング (Scaling Buffer)

ゲーム画面を常にネイティブ解像度（ズームなし）でオフスクリーン Canvas に描画し、それをメイン Canvas に拡大・縮小して転送します。

*   **実装イメージ:**
    1. `offscreenCtx` に `zoom=1` で全タイルを描画。
    2. メインの `ctx` に `offscreenCanvas` を `ctx.drawImage` で拡大縮小して描画。
*   **メリット:** タイル間の隙間は物理的に発生しない。
*   **デメリット:** 解像度感が変わる（レトロゲーム風になる）。高解像度のテクスチャを使用している場合はディテールが損なわれる。メモリ使用量が増える。

## 推奨される対応

まずは **「案1: 描画領域の拡張 (Overlap)」** を試すことをお勧めします。
特に `src/renderer.js` 内の不透明ブロック（DIRT, STONE等）の描画部分に `width + 1` / `height + 1` 程度のオーバーラップを追加するだけで、視覚的な違和感なく白線を消すことができます。

水（WATER）などの半透明ブロックについては、オーバーラップさせると境界線が濃くなってしまうため、**「案1」と「案3（幅・高さの切り上げ）」** を組み合わせるか、水だけは通常通り描画するなどの調整が必要です。
